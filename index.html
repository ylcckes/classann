<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™®æ™®é¢¨å…¬å‘Šç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Bangers&family=Chewy&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .font-pop {
            font-family: 'Bangers', cursive;
        }
        .font-chewy {
            font-family: 'Chewy', cursive;
        }
        .pop-shadow {
            box-shadow: 8px 8px 0px #000000;
            border: 4px solid #000000;
        }
        .pop-shadow-sm {
            box-shadow: 4px 4px 0px #000000;
            border: 2px solid #000000;
        }
        .pop-button {
            transition: all 0.1s ease-in-out;
        }
        .pop-button:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        .pop-button:disabled {
            background-color: #9E9E9E;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        input[type="file"] {
            display: none;
        }
        .custom-file-upload {
            border: 2px solid #000;
            display: inline-block;
            padding: 8px 12px;
            cursor: pointer;
            background-color: #fff;
            color: #000;
            border-radius: 0.375rem;
            font-weight: bold;
        }

        /* ===================== ä¸»é¡Œç³»çµ± ===================== */

        /* ---------- ä¸»é¡Œ 1ï¼šæ™®æ™®è—ï¼ˆé è¨­ï¼‰ ---------- */
        body.theme-pop-blue {
            background-color: #64B5F6;
        }
        body.theme-pop-blue .dots-background {
            background-color: #FFF9C4;
            background-image: radial-gradient(#448AFF 15%, transparent 16%),
                              radial-gradient(#448AFF 15%, transparent 16%);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
        }
        body.theme-pop-blue #system-title {
            color: white;
            text-shadow: 3px 3px 0px #1A237E;
        }
        body.theme-pop-blue #publish-btn {
            background-color: #FFA726;
            color: white;
        }

        /* ---------- ä¸»é¡Œ 2ï¼šç«ç‘°çŸ³è‹±ï¼ˆç¾ä»£æŸ”ç¾ï¼‰ ---------- */
        body.theme-rose-quartz {
            background: linear-gradient(160deg, #fce4ec 0%, #f8bbd0 30%, #e8d5e8 65%, #d1c4e9 100%);
            min-height: 100vh;
        }
        body.theme-rose-quartz .dots-background {
            background-color: rgba(255,255,255,0.65) !important;
            background-image: none !important;
            border: 1px solid rgba(206,147,216,0.4) !important;
            box-shadow: 0 8px 32px rgba(186,104,200,0.12), inset 0 1px 0 rgba(255,255,255,0.8) !important;
            border-radius: 1.5rem !important;
            backdrop-filter: blur(8px);
        }
        body.theme-rose-quartz #system-title {
            background: linear-gradient(135deg, #c2185b, #9c27b0, #e91e63);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
            filter: drop-shadow(0 2px 6px rgba(194,24,91,0.3));
        }
        body.theme-rose-quartz #publish-btn {
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            color: white;
            border: none;
            box-shadow: 0 4px 20px rgba(233,30,99,0.4), 0 2px 8px rgba(156,39,176,0.3);
            text-shadow: none;
            font-weight: 900;
            border-radius: 2rem;
            transition: all 0.2s;
        }
        body.theme-rose-quartz #publish-btn:hover {
            box-shadow: 0 6px 30px rgba(233,30,99,0.55), 0 4px 16px rgba(156,39,176,0.4);
            transform: translateY(-1px);
        }
        body.theme-rose-quartz #search-input {
            background: rgba(255,255,255,0.75);
            border: 1.5px solid rgba(206,147,216,0.6);
            color: #4a1060;
            border-radius: 2rem;
            box-shadow: 0 2px 12px rgba(186,104,200,0.15), inset 0 1px 3px rgba(0,0,0,0.05);
        }
        body.theme-rose-quartz #search-input::placeholder { color: rgba(156,39,176,0.45); }
        body.theme-rose-quartz #search-input:focus {
            outline: none;
            border-color: #ce93d8;
            box-shadow: 0 0 0 3px rgba(206,147,216,0.3), 0 2px 12px rgba(186,104,200,0.2);
        }
        body.theme-rose-quartz .announcement-item {
            background: rgba(255,255,255,0.75) !important;
            border: 1.5px solid rgba(206,147,216,0.35) !important;
            border-radius: 1rem !important;
            box-shadow: 0 2px 12px rgba(186,104,200,0.1) !important;
            backdrop-filter: blur(6px);
            transition: all 0.2s ease;
        }
        body.theme-rose-quartz .announcement-item:hover {
            background: rgba(252,228,236,0.9) !important;
            border-color: rgba(233,30,99,0.4) !important;
            box-shadow: 0 6px 24px rgba(233,30,99,0.15), 0 0 0 1px rgba(206,147,216,0.5) !important;
            transform: translateY(-2px);
        }
        body.theme-rose-quartz .announcement-item h3 {
            color: #6a1b9a;
            font-weight: 700;
        }
        body.theme-rose-quartz .pagination-btn {
            background: linear-gradient(135deg, #e91e63, #9c27b0) !important;
            color: white !important;
            border: none !important;
            box-shadow: 0 4px 15px rgba(233,30,99,0.35) !important;
            border-radius: 2rem !important;
            font-weight: 700;
        }
        body.theme-rose-quartz #pagination-container span {
            color: #880e4f !important;
            font-weight: 700;
        }
        body.theme-rose-quartz footer p { color: #9c27b0 !important; text-shadow: none; }
        body.theme-rose-quartz footer a { color: #e91e63 !important; }
        body.theme-rose-quartz #theme-toggle-btn {
            background: rgba(233,30,99,0.1);
            border: 1.5px solid rgba(206,147,216,0.5);
            border-radius: 2rem;
            color: #c2185b;
        }

        /* ---------- å…¬å‘Šè¡¨æ ¼ ---------- */
        .ann-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .ann-table thead tr th {
            position: sticky;
            top: 0;
            z-index: 1;
            padding: 10px 12px;
            font-weight: 900;
            font-size: 0.85rem;
            text-align: left;
            white-space: nowrap;
            background: #1A237E;
            color: #fff;
            border-bottom: 3px solid #000;
        }
        .ann-table thead tr th:first-child { border-radius: 6px 0 0 0; }
        .ann-table thead tr th:last-child  { border-radius: 0 6px 0 0; }
        .ann-table tbody tr {
            cursor: pointer;
            transition: background 0.12s;
        }
        .ann-table tbody tr:hover td { background: #FFF9C4; }
        .ann-table tbody tr td {
            padding: 9px 12px;
            font-size: 0.92rem;
            border-bottom: 2px solid #e0e0e0;
            background: #fff;
            vertical-align: middle;
        }
        .ann-table .col-no    { width: 3.2rem; text-align: center; font-weight: 700; }
        .ann-table .col-title { min-width: 120px; font-weight: 700; }
        .ann-table .col-preview { min-width: 100px; }
        .ann-table tbody td.col-preview { color: #555; }
        .ann-table .col-links { min-width: 80px; }
        .ann-table .link-chip {
            display: inline-block;
            background: #E3F2FD;
            color: #1565C0;
            border: 1px solid #90CAF9;
            border-radius: 999px;
            padding: 1px 9px;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 1px 2px;
            text-decoration: none;
            transition: background 0.1s;
            white-space: nowrap;
        }
        .ann-table .link-chip:hover { background: #BBDEFB; }

        /* ç«ç‘°çŸ³è‹±ä¸»é¡Œçš„è¡¨æ ¼è¦†è“‹ */
        body.theme-rose-quartz .ann-table thead tr th {
            background: #880e4f;
        }
        body.theme-rose-quartz .ann-table tbody tr:hover td { background: #fce4ec; }
        body.theme-rose-quartz .ann-table .link-chip {
            background: #FCE4EC;
            color: #880e4f;
            border-color: #F48FB1;
        }
        body.theme-rose-quartz .ann-table .link-chip:hover { background: #F8BBD0; }

        /* ---------- ä¸»é¡Œåˆ‡æ›å–®ä¸€æŒ‰éˆ• ---------- */
        #theme-toggle-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: 2rem;
            border: 2px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.2);
            color: white;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        #theme-toggle-btn:hover { transform: scale(1.05); }
        #theme-toggle-btn .theme-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }
    </style>
</head>
<body class="theme-pop-blue text-black">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">

        <!-- æ¨™é¡Œå’Œæ§åˆ¶æŒ‰éˆ• -->
        <header class="flex justify-between items-center mb-8">
            <h1 id="system-title" class="font-black text-4xl md:text-6xl text-white" style="text-shadow: 3px 3px 0px #1A237E;">å…¬å‘Šç³»çµ±</h1>
            <div class="flex items-center space-x-2">
                <!-- å–®ä¸€ä¸»é¡Œåˆ‡æ›æŒ‰éˆ• -->
                <button id="theme-toggle-btn" title="åˆ‡æ›ä¸»é¡Œ">
                    <span class="theme-dot" id="theme-dot-indicator"></span>
                    <span id="theme-toggle-label">åˆ‡æ›ä¸»é¡Œ</span>
                </button>
                <button id="settings-btn" class="text-3xl transform hover:scale-110 transition-transform" title="è¨­å®š">âš™ï¸</button>
                <button id="help-btn" class="text-3xl transform hover:scale-110 transition-transform" title="èªªæ˜">â„¹ï¸</button>
            </div>
        </header>

        <!-- æœå°‹èˆ‡ç™¼å¸ƒå€å¡Š -->
        <div class="flex flex-col md:flex-row md:items-center md:space-x-6 mb-8">
            <!-- æœå°‹æ¡† -->
            <div class="flex-grow mb-4 md:mb-0 relative">
                <input type="search" id="search-input" placeholder="æœå°‹å…¬å‘Šæ¨™é¡Œ..." class="w-full p-4 pl-12 rounded-lg border-4 border-black text-lg font-bold focus:outline-none focus:ring-4 focus:ring-yellow-300">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <svg class="h-6 w-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>
            <!-- ç™¼å¸ƒæŒ‰éˆ• -->
            <div class="flex-shrink-0 text-center">
                <button id="publish-btn" class="font-black text-2xl bg-[#FFA726] text-white px-8 py-3 rounded-lg pop-shadow pop-button" style="text-shadow: 2px 2px 0px #000;">
                    ç™¼å¸ƒæ–°å…¬å‘Š!
                </button>
            </div>
        </div>

        <!-- å…¬å‘Šåˆ—è¡¨ -->
        <main id="announcement-list" class="bg-[#FFF9C4] p-6 rounded-lg pop-shadow dots-background space-y-4 min-h-[400px]">
             <div id="loader" class="text-center py-16">
                <p class="text-2xl font-bold animate-pulse">è®€å–ä¸­...</p>
            </div>
        </main>

        <!-- åˆ†é æ§åˆ¶å™¨ -->
        <div id="pagination-container" class="mt-6 flex justify-center items-center space-x-4">
            <!-- åˆ†é æŒ‰éˆ•æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
        </div>

    </div>

    <!-- å½ˆå‡ºè¦–çª—ï¼šè¼¸å…¥å¯†ç¢¼ï¼ˆç”¨æ–¼ç™¼å¸ƒ / ç·¨è¼¯ / åˆªé™¤ï¼‰ -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-[#29B6F6] w-full max-w-sm p-8 rounded-lg pop-shadow relative">
            <button id="close-password-modal" class="absolute top-4 right-4 text-4xl font-bold text-white hover:text-yellow-300">&times;</button>
            <h2 id="password-modal-title" class="font-black text-4xl text-white text-center mb-2" style="text-shadow: 3px 3px 0px #000;">è«‹è¼¸å…¥å¯†ç¢¼</h2>
            <p id="password-modal-hint" class="text-blue-100 text-sm text-center mb-4">è‹¥æœªè¨­å®šå¯†ç¢¼è«‹ç•™ç©ºç›´æ¥é€å‡º</p>
            <form id="password-form" class="space-y-4">
                <input type="password" id="password-input" placeholder="ç™¼å¸ƒå¯†ç¢¼ï¼ˆç•™ç©º=ç„¡å¯†ç¢¼ï¼‰" class="w-full p-3 rounded-md border-2 border-black text-lg font-bold text-center">
                <div id="password-error" class="hidden text-red-200 font-bold text-center bg-red-600 rounded p-2">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦ï¼</div>
                <button type="submit" id="password-submit-btn" class="font-bold text-2xl w-full bg-[#FFA726] text-white px-6 py-3 rounded-lg pop-shadow pop-button" style="text-shadow: 2px 2px 0px #000;">
                    ç¢ºèª
                </button>
            </form>
        </div>
    </div>

    <!-- å½ˆå‡ºè¦–çª—ï¼šç™¼å¸ƒå…¬å‘Š -->
    <div id="publish-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-[#2196F3] w-full max-w-2xl p-8 rounded-lg pop-shadow relative max-h-[90vh] overflow-y-auto no-scrollbar">
            <button id="close-publish-modal" class="absolute top-4 right-4 text-4xl font-bold text-white hover:text-yellow-300">&times;</button>
            <h2 class="font-black text-5xl text-white text-center mb-6" style="text-shadow: 3px 3px 0px #000;">æ–°å¢å…¬å‘Š</h2>
            <form id="publish-form" class="space-y-4">
                <input type="text" id="title-input" placeholder="å…¬å‘Šæ¨™é¡Œ..." class="w-full p-3 rounded-md border-2 border-black text-lg font-bold" required>
                <textarea id="content-input" placeholder="å…¬å‘Šå…§å®¹..." rows="6" class="w-full p-3 rounded-md border-2 border-black text-lg" required></textarea>
                <div>
                    <label for="image-upload-input" class="custom-file-upload pop-button">ğŸ“‚ é¸æ“‡åœ–ç‰‡ (é¸å¡«)</label>
                    <input type="file" id="image-upload-input" accept="image/*">
                    <span id="file-name" class="ml-3 text-white font-semibold">æœªé¸æ“‡ä»»ä½•æª”æ¡ˆ</span>
                    <img id="image-preview" class="mt-2 rounded-lg max-w-xs max-h-32 hidden border-2 border-black">
                </div>
                <!-- å¤šé€£çµå€å¡Š -->
                <div class="border-t-2 border-blue-300 pt-4">
                    <label class="block text-white font-bold mb-2">ç›¸é—œé€£çµ (é¸å¡«)</label>
                    <div id="links-container" class="space-y-2 h-36 overflow-y-auto pr-2">
                        <!-- Link inputs will be dynamically added here -->
                    </div>
                    <button type="button" id="add-link-btn" class="w-full mt-2 text-sm bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg border-2 border-blue-300 hover:bg-blue-200 pop-button">ï¼‹ æ–°å¢é€£çµ</button>
                </div>
                <button type="submit" id="submit-btn" class="font-bold text-2xl w-full bg-[#FFA726] text-white px-6 py-3 rounded-lg pop-shadow pop-button" style="text-shadow: 2px 2px 0px #000;">
                    ç™¼ä½ˆï¼
                </button>
                <div id="publish-loader" class="text-center text-white font-bold hidden">ç™¼ä½ˆä¸­...</div>
            </form>
        </div>
    </div>

    <!-- å½ˆå‡ºè¦–çª—ï¼šè¨­å®š -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-[#29B6F6] w-full max-w-lg p-8 rounded-lg pop-shadow relative max-h-[90vh] overflow-y-auto no-scrollbar">
            <button id="close-settings-modal" class="absolute top-4 right-4 text-4xl font-bold text-white hover:text-yellow-300">&times;</button>
            <h2 class="font-black text-5xl text-white text-center mb-6" style="text-shadow: 3px 3px 0px #000;">è¨­å®š</h2>
            <div class="space-y-4">
                <!-- GAS URL è¼¸å…¥ -->
                <div>
                    <label for="gas-url-input" class="block text-white font-bold text-lg mb-1">Google Apps Script ç¶²é æ‡‰ç”¨ç¶²å€:</label>
                    <p class="text-blue-100 text-sm mb-2">å°‡ GAS Web App URL è²¼å…¥å¾Œå„²å­˜ï¼Œä¸‹æ¬¡é–‹å•Ÿç¶²é å°‡è‡ªå‹•é€£ç·šã€‚</p>
                    <!-- type="password" è®“ç¶²å€ä¸ç›´æ¥é¡¯ç¤ºç‚ºæ˜ç¢¼ -->
                    <input type="password" id="gas-url-input" placeholder="https://script.google.com/macros/s/..." class="w-full p-3 rounded-md border-2 border-black text-lg">
                </div>
                <button id="save-settings-btn" class="font-bold text-xl w-full bg-[#FFA726] text-white px-6 py-3 rounded-lg pop-shadow pop-button" style="text-shadow: 2px 2px 0px #000;">
                    ğŸ’¾ å„²å­˜è¨­å®š
                </button>

                <!-- åˆ†äº«é€£çµèˆ‡ QR Code å€å¡Š -->
                <div class="border-t-2 border-blue-300 pt-4">
                    <h3 class="text-white font-black text-2xl mb-3">ğŸ“¤ ç”¢ç”Ÿåˆ†äº«é€£çµ</h3>
                    <p class="text-blue-100 text-sm mb-3">ç”¢ç”Ÿå¸¶æœ‰é€£ç·šè¨­å®šçš„åˆ†äº«ç¶²å€ï¼ˆGAS ç¶²å€ä»¥ Base64 åŠ å¯†å¾Œé™„æ–¼åƒæ•¸ä¸­ï¼‰ï¼Œå¯è®“å…¶ä»–äººæƒ QR Code ç›´æ¥ä½¿ç”¨ã€‚</p>
                    <button id="generate-share-btn" class="font-bold text-lg w-full bg-green-500 text-white px-4 py-2 rounded-lg pop-shadow pop-button border-2 border-black">
                        ğŸ”— ç”¢ç”Ÿåˆ†äº«é€£çµ & QR Code
                    </button>
                    <div id="share-result" class="mt-4 hidden">
                        <div class="bg-white rounded-lg p-3 border-2 border-black">
                            <p class="font-bold text-sm text-gray-700 mb-1">åŸå§‹åˆ†äº«é€£çµï¼š</p>
                            <p id="share-long-url" class="text-xs text-gray-500 break-all mb-3"></p>
                            <div id="short-url-section" class="hidden mb-3">
                                <p class="font-bold text-sm text-gray-700 mb-1">çŸ­ç¶²å€ï¼š</p>
                                <a id="share-short-url" href="#" target="_blank" class="text-blue-600 font-bold underline break-all text-sm"></a>
                                <button id="copy-short-url-btn" class="ml-2 bg-blue-500 text-white px-2 py-1 text-xs rounded font-bold">è¤‡è£½</button>
                            </div>
                            <div id="short-url-loading" class="hidden text-sm text-gray-500 mb-3">æ­£åœ¨ç”ŸæˆçŸ­ç¶²å€...</div>
                            <div id="qr-code-container" class="text-center">
                                <p class="font-bold text-sm text-gray-700 mb-2">QR Codeï¼š</p>
                                <img id="qr-code-img" src="" alt="QR Code" class="mx-auto border-2 border-black rounded" style="max-width:180px;">
                                <p class="text-xs text-gray-400 mt-1">æƒæå¾Œå¯ç›´æ¥ä½¿ç”¨æœ¬ç³»çµ±</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¸…é™¤è¨­å®š -->
                <div class="border-t-2 border-blue-300 pt-4">
                    <h3 class="text-white font-black text-2xl mb-3">ğŸ—‘ï¸ æ¸…é™¤è¨­å®š</h3>
                    <p class="text-blue-100 text-sm mb-3">é»æ“Šå¾Œå°‡åˆªé™¤æœ¬åœ°å„²å­˜çš„ GAS ç¶²å€ï¼Œä¸¦é‡æ–°æ•´ç†é é¢ã€‚</p>
                    <button id="clear-settings-btn" class="font-bold text-xl w-full bg-red-500 text-white px-6 py-3 rounded-lg pop-shadow pop-button border-2 border-black" style="text-shadow: 1px 1px 0px #000;">
                        ğŸ—‘ï¸ æ¸…é™¤ / é‡ç½®è¨­å®š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å½ˆå‡ºè¦–çª—ï¼šèªªæ˜ -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white w-full max-w-3xl p-6 md:p-8 rounded-lg pop-shadow relative max-h-[90vh] overflow-y-auto no-scrollbar">
            <button id="close-help-modal" class="absolute top-4 right-4 text-4xl font-bold text-black hover:text-red-500">&times;</button>
            <div id="help-content" class="prose max-w-none"></div>
        </div>
    </div>

    <!-- å½ˆå‡ºè¦–çª—ï¼šå…¬å‘Šå…§æ–‡ -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
         <div class="bg-white w-full max-w-2xl p-6 md:p-8 rounded-lg pop-shadow relative max-h-[90vh] flex flex-col">
            <!-- é—œé–‰ / ç·¨è¼¯ / åˆªé™¤ å°åœ–ç¤ºåˆ— -->
            <div class="absolute top-3 right-3 flex items-center gap-1">
                <button id="edit-ann-btn" title="ç·¨è¼¯å…¬å‘Š"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-100 hover:bg-blue-200 text-blue-700 transition-colors text-base leading-none">âœï¸</button>
                <button id="delete-ann-btn" title="åˆªé™¤å…¬å‘Š"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-red-100 hover:bg-red-200 text-red-700 transition-colors text-base leading-none">ğŸ—‘ï¸</button>
                <button id="close-detail-modal"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors text-xl font-bold leading-none">&times;</button>
            </div>
            <h2 id="detail-title" class="font-black text-4xl md:text-5xl text-center mb-4 text-[#1A237E] pr-28"></h2>
            <div class="flex-grow overflow-y-auto no-scrollbar pr-4 -mr-4">
                <p id="detail-timestamp" class="text-sm text-gray-500 mb-4 text-center"></p>
                <img id="detail-image" src="" alt="å…¬å‘Šåœ–ç‰‡" class="max-w-full mx-auto rounded-lg border-2 border-black mb-4 hidden">
                <div class="relative">
                    <p id="detail-content" class="text-lg whitespace-pre-wrap bg-gray-100 px-4 pt-4 pb-[30px] rounded border-2 border-gray-300"></p>
                    <button id="copy-content-btn" class="absolute bottom-2 right-2 bg-[#FFA726] text-black px-2 py-1 text-xs font-bold rounded pop-shadow-sm pop-button">è¤‡è£½</button>
                </div>
                <div id="detail-links-container" class="mt-6 space-y-2">
                    <!-- Links will be dynamically rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- å½ˆå‡ºè¦–çª—ï¼šç·¨è¼¯å…¬å‘Š -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-[#1976D2] w-full max-w-2xl p-8 rounded-lg pop-shadow relative max-h-[90vh] overflow-y-auto no-scrollbar">
            <button id="close-edit-modal" class="absolute top-4 right-4 text-4xl font-bold text-white hover:text-yellow-300">&times;</button>
            <h2 class="font-black text-5xl text-white text-center mb-6" style="text-shadow: 3px 3px 0px #000;">ç·¨è¼¯å…¬å‘Š</h2>
            <form id="edit-form" class="space-y-4">
                <input type="text" id="edit-title-input" placeholder="å…¬å‘Šæ¨™é¡Œ..." class="w-full p-3 rounded-md border-2 border-black text-lg font-bold" required>
                <textarea id="edit-content-input" placeholder="å…¬å‘Šå…§å®¹..." rows="6" class="w-full p-3 rounded-md border-2 border-black text-lg" required></textarea>
                <div>
                    <label for="edit-image-upload-input" class="custom-file-upload pop-button">ğŸ“‚ æ›´æ›åœ–ç‰‡ (é¸å¡«)</label>
                    <input type="file" id="edit-image-upload-input" accept="image/*">
                    <span id="edit-file-name" class="ml-3 text-white font-semibold">æœªé¸æ“‡ï¼ˆä¿ç•™åŸåœ–ï¼‰</span>
                    <img id="edit-image-preview" class="mt-2 rounded-lg max-w-xs max-h-32 hidden border-2 border-black">
                </div>
                <div class="border-t-2 border-blue-300 pt-4">
                    <label class="block text-white font-bold mb-2">ç›¸é—œé€£çµ (é¸å¡«)</label>
                    <div id="edit-links-container" class="space-y-2 max-h-36 overflow-y-auto pr-2"></div>
                    <button type="button" id="edit-add-link-btn" class="w-full mt-2 text-sm bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg border-2 border-blue-300 hover:bg-blue-200 pop-button">ï¼‹ æ–°å¢é€£çµ</button>
                </div>
                <button type="submit" id="edit-submit-btn" class="font-bold text-2xl w-full bg-[#FFA726] text-white px-6 py-3 rounded-lg pop-shadow pop-button" style="text-shadow: 2px 2px 0px #000;">
                    å„²å­˜ä¿®æ”¹
                </button>
                <div id="edit-loader" class="text-center text-white font-bold hidden">æ›´æ–°ä¸­...</div>
            </form>
        </div>
    </div>

    <footer class="text-center p-4 mt-4 mb-8 space-y-2">
        <!-- CC æˆæ¬Šè²æ˜ -->
        <div class="inline-flex items-center gap-2 bg-white bg-opacity-20 backdrop-blur-sm rounded-xl px-4 py-2 border border-white border-opacity-30">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" viewBox="0 0 24 24" fill="white">
                <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18a8 8 0 110-16 8 8 0 010 16zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
            </svg>
            <span class="text-white text-xs font-semibold" style="text-shadow:1px 1px 2px #000;">
                æœ¬ç³»çµ±å…§å®¹æ¡
                <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hant" target="_blank" rel="noopener noreferrer"
                   class="underline font-bold hover:text-yellow-200 transition-colors">
                    CC BY-NC-SA 4.0
                </a>
                æˆæ¬Š â€” å§“åæ¨™ç¤ºã€éå•†æ¥­ä½¿ç”¨ã€ç›¸åŒæ–¹å¼åˆ†äº«
            </span>
        </div>
        <p class="text-white text-sm" style="text-shadow: 1px 1px 2px #000;">
            Made by <a href="https://kentxchang.blogspot.tw" target="_blank" rel="noopener noreferrer" class="font-bold underline hover:text-yellow-300 transition-colors">é˜¿å‰›è€å¸«</a>
        </p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // ================================================================
            // ã€è¨­å®šå€ã€‘
            // è‹¥æ‚¨æƒ³å°‡ GAS ç¶²å€ç›´æ¥å¯«å…¥ç¨‹å¼ç¢¼ï¼Œè«‹åœ¨ä¸‹æ–¹å¡«å…¥ï¼š
            // ä¾‹å¦‚ï¼šconst DEFAULT_GAS_URL = 'https://script.google.com/macros/s/YOUR_ID/exec';
            // ç•™ç©ºå­—ä¸² "" è¡¨ç¤ºä¸ä½¿ç”¨ç¡¬ç·¨ç¢¼é è¨­å€¼ï¼Œç³»çµ±å°‡å¾ LocalStorage æˆ–ç¶²å€åƒæ•¸è®€å–ã€‚
            // ================================================================
            const DEFAULT_GAS_URL = "https://script.google.com/macros/s/AKfycbzlNvxhABo8BSUWgPNv9njMdO6ezzR81le5W8L7eZL7nv7SFT7byKEPG6Wl-X-QBpgDpw/exec";

            // æ“ä½œæ¨¡å¼æ——æ¨™ï¼šç›®å‰å¯†ç¢¼è¦–çª—çš„ç”¨é€”
            // 'publish' | 'edit' | 'delete'
            let passwordPurpose = 'publish';

            // --- LocalStorage éµå ---
            const LS_GAS_URL_KEY    = 'popSystem_gasUrl';
            const LS_THEME_KEY      = 'popSystem_theme';
            const CACHE_KEY         = 'announcements_cache';
            const CACHE_TIMESTAMP_KEY = 'announcements_cache_timestamp';
            const CACHE_DURATION    = 5 * 60 * 1000; // 5 åˆ†é˜

            // ================================================================
            // GAS URL å„ªå…ˆé †åºï¼š
            //   1. ç¶²å€åƒæ•¸ ?config=BASE64_ENCODED_URL  (æœ€é«˜å„ªå…ˆ)
            //   2. LocalStorage
            //   3. åŸå§‹ç¢¼é è¨­å€¼ DEFAULT_GAS_URL
            // ================================================================
            const resolveGasUrl = () => {
                // 1. æª¢æŸ¥ç¶²å€åƒæ•¸
                const params = new URLSearchParams(window.location.search);
                const configParam = params.get('config');
                if (configParam) {
                    try {
                        const decoded = atob(configParam);
                        if (decoded.startsWith('http')) {
                            // å­˜å…¥ LocalStorage ä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨
                            localStorage.setItem(LS_GAS_URL_KEY, decoded);
                            // ç§»é™¤ç¶²å€åƒæ•¸ï¼Œè®“ç¶²å€æ›´ä¹¾æ·¨ï¼ˆéå¿…è¦ï¼Œå¯ç§»é™¤æ­¤æ®µï¼‰
                            const cleanUrl = window.location.origin + window.location.pathname;
                            window.history.replaceState({}, document.title, cleanUrl);
                            return decoded;
                        }
                    } catch (e) {
                        console.warn('ç„¡æ³•è§£ç¢¼ ?config åƒæ•¸:', e);
                    }
                }
                // 2. LocalStorage
                const stored = localStorage.getItem(LS_GAS_URL_KEY);
                if (stored && stored.startsWith('http')) return stored;
                // 3. ç¡¬ç·¨ç¢¼é è¨­å€¼
                return DEFAULT_GAS_URL;
            };

            let gasUrl = resolveGasUrl();

            // --- DOM å…ƒç´  ---
            const systemTitle         = document.getElementById('system-title');
            const announcementList    = document.getElementById('announcement-list');
            const loader              = document.getElementById('loader');
            const searchInput         = document.getElementById('search-input');
            const paginationContainer = document.getElementById('pagination-container');
            // Modals
            const passwordModal  = document.getElementById('password-modal');
            const publishModal   = document.getElementById('publish-modal');
            const settingsModal  = document.getElementById('settings-modal');
            const helpModal      = document.getElementById('help-modal');
            const detailModal    = document.getElementById('detail-modal');
            const editModal      = document.getElementById('edit-modal');
            // Buttons
            const publishBtn          = document.getElementById('publish-btn');
            const helpBtn             = document.getElementById('help-btn');
            const settingsBtn         = document.getElementById('settings-btn');
            const closePasswordModalBtn = document.getElementById('close-password-modal');
            const closePublishModalBtn  = document.getElementById('close-publish-modal');
            const closeSettingsModalBtn = document.getElementById('close-settings-modal');
            const closeHelpModalBtn     = document.getElementById('close-help-modal');
            const closeDetailModalBtn   = document.getElementById('close-detail-modal');
            const closeEditModalBtn     = document.getElementById('close-edit-modal');
            const saveSettingsBtn     = document.getElementById('save-settings-btn');
            const clearSettingsBtn    = document.getElementById('clear-settings-btn');
            const copyContentBtn      = document.getElementById('copy-content-btn');
            const addLinkBtn          = document.getElementById('add-link-btn');
            const generateShareBtn    = document.getElementById('generate-share-btn');
            const copyShortUrlBtn     = document.getElementById('copy-short-url-btn');
            const editAnnBtn          = document.getElementById('edit-ann-btn');
            const deleteAnnBtn        = document.getElementById('delete-ann-btn');
            const editAddLinkBtn      = document.getElementById('edit-add-link-btn');
            // Password modal UI
            const passwordModalTitle  = document.getElementById('password-modal-title');
            const passwordModalHint   = document.getElementById('password-modal-hint');
            const passwordError       = document.getElementById('password-error');
            const passwordSubmitBtn   = document.getElementById('password-submit-btn');
            // Forms and Inputs
            const passwordForm     = document.getElementById('password-form');
            const passwordInput    = document.getElementById('password-input');
            const publishForm      = document.getElementById('publish-form');
            const submitBtn        = document.getElementById('submit-btn');
            const publishLoader    = document.getElementById('publish-loader');
            const gasUrlInput      = document.getElementById('gas-url-input');
            const titleInput       = document.getElementById('title-input');
            const contentInput     = document.getElementById('content-input');
            const imageUploadInput = document.getElementById('image-upload-input');
            const fileNameSpan     = document.getElementById('file-name');
            const imagePreview     = document.getElementById('image-preview');
            const linksContainer   = document.getElementById('links-container');
            // Edit Form
            const editForm            = document.getElementById('edit-form');
            const editTitleInput      = document.getElementById('edit-title-input');
            const editContentInput    = document.getElementById('edit-content-input');
            const editImageUpload     = document.getElementById('edit-image-upload-input');
            const editFileName        = document.getElementById('edit-file-name');
            const editImagePreview    = document.getElementById('edit-image-preview');
            const editLinksContainer  = document.getElementById('edit-links-container');
            const editSubmitBtn       = document.getElementById('edit-submit-btn');
            const editLoader          = document.getElementById('edit-loader');
            // Detail View
            const detailTitle          = document.getElementById('detail-title');
            const detailTimestamp      = document.getElementById('detail-timestamp');
            const detailImage          = document.getElementById('detail-image');
            const detailContent        = document.getElementById('detail-content');
            const detailLinksContainer = document.getElementById('detail-links-container');
            // Share
            const shareResult      = document.getElementById('share-result');
            const shareLongUrl     = document.getElementById('share-long-url');
            const shareShortUrl    = document.getElementById('share-short-url');
            const shortUrlSection  = document.getElementById('short-url-section');
            const shortUrlLoading  = document.getElementById('short-url-loading');
            const qrCodeImg        = document.getElementById('qr-code-img');

            // --- ç‹€æ…‹ ---
            let allAnnouncements  = [];
            let imageBase64       = null;
            let editImageBase64   = null;   // ç·¨è¼¯æ™‚çš„æ–°åœ–ç‰‡
            let currentPassword   = null;
            let currentPage       = 1;
            let currentDetailIdx  = null;   // ç›®å‰è©³æƒ…è¦–çª—é¡¯ç¤ºçš„ originalIndex
            const itemsPerPage    = 10;

            // ================================================================
            // ä¸»é¡Œç®¡ç†ï¼ˆå–®ä¸€æŒ‰éˆ•å¾ªç’°åˆ‡æ›ï¼‰
            // ================================================================
            const themes = [
                {
                    id: 'theme-pop-blue',
                    label: 'æ™®æ™®è—',
                    dotColor: 'linear-gradient(135deg,#64B5F6,#1A237E)'
                },
                {
                    id: 'theme-rose-quartz',
                    label: 'ç«ç‘°çŸ³è‹±',
                    dotColor: 'linear-gradient(135deg,#e91e63,#9c27b0,#fce4ec)'
                }
            ];

            const themeToggleBtn   = document.getElementById('theme-toggle-btn');
            const themeDotIndicator = document.getElementById('theme-dot-indicator');
            const themeToggleLabel  = document.getElementById('theme-toggle-label');

            const applyTheme = (themeId) => {
                document.body.classList.remove(...themes.map(t => t.id));
                document.body.classList.add(themeId);
                localStorage.setItem(LS_THEME_KEY, themeId);
                const themeObj = themes.find(t => t.id === themeId);
                if (themeObj) {
                    themeDotIndicator.style.background = themeObj.dotColor;
                    themeToggleLabel.textContent = themeObj.label;
                }
            };

            // å–®ä¸€æŒ‰éˆ•ï¼šæ¯æ¬¡é»æ“Šåˆ‡æ›åˆ°ä¸‹ä¸€å€‹ä¸»é¡Œ
            themeToggleBtn.addEventListener('click', () => {
                const currentTheme = themes.find(t => document.body.classList.contains(t.id));
                const currentIdx   = currentTheme ? themes.indexOf(currentTheme) : 0;
                const nextTheme    = themes[(currentIdx + 1) % themes.length];
                applyTheme(nextTheme.id);
            });

            // è®€å–å„²å­˜çš„ä¸»é¡Œ
            const savedTheme = localStorage.getItem(LS_THEME_KEY) || 'theme-pop-blue';
            applyTheme(savedTheme);

            // ================================================================
            // å¿«å–ç®¡ç†
            // ================================================================
            const saveToCache = (data) => {
                try {
                    localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                    localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());
                } catch (e) { console.warn('å¿«å–å„²å­˜å¤±æ•—:', e); }
            };

            const loadFromCache = () => {
                try {
                    const ts   = localStorage.getItem(CACHE_TIMESTAMP_KEY);
                    const data = localStorage.getItem(CACHE_KEY);
                    if (!ts || !data) return null;
                    if (Date.now() - parseInt(ts) > CACHE_DURATION) {
                        localStorage.removeItem(CACHE_KEY);
                        localStorage.removeItem(CACHE_TIMESTAMP_KEY);
                        return null;
                    }
                    return JSON.parse(data);
                } catch (e) { return null; }
            };

            const clearCache = () => {
                localStorage.removeItem(CACHE_KEY);
                localStorage.removeItem(CACHE_TIMESTAMP_KEY);
            };

            // ================================================================
            // å·¥å…·å‡½æ•¸
            // ================================================================
            const toggleModal = (modal, show) => {
                if (show) modal.classList.remove('hidden');
                else modal.classList.add('hidden');
            };

            const showToast = (message, isError = false) => {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.className = `fixed bottom-5 right-5 p-4 rounded-lg text-white font-bold pop-shadow z-[100] ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            };

            // ================================================================
            // è¨­å®šåŠŸèƒ½
            // ================================================================
            // é–‹å•Ÿè¨­å®šè¦–çª—æ™‚ï¼Œå¡«å…¥ç›®å‰çš„ GAS URLï¼ˆé®è”½é¡¯ç¤ºï¼‰
            settingsBtn.addEventListener('click', () => {
                gasUrlInput.value = gasUrl || '';
                shareResult.classList.add('hidden');
                toggleModal(settingsModal, true);
            });

            saveSettingsBtn.addEventListener('click', () => {
                const inputVal = gasUrlInput.value.trim();
                if (!inputVal) {
                    showToast('è«‹è¼¸å…¥ GAS ç¶²å€ï¼', true);
                    return;
                }
                if (!inputVal.startsWith('http')) {
                    showToast('ç¶²å€æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚', true);
                    return;
                }
                gasUrl = inputVal;
                localStorage.setItem(LS_GAS_URL_KEY, gasUrl);
                showToast('è¨­å®šå·²å„²å­˜ï¼æ­£åœ¨é‡æ–°è¼‰å…¥å…¬å‘Š...');
                toggleModal(settingsModal, false);
                clearCache();
                fetchAnnouncements(true);
            });

            clearSettingsBtn.addEventListener('click', () => {
                if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¨­å®šä¸¦é‡ç½®é€£ç·šå—ï¼Ÿ')) return;
                localStorage.removeItem(LS_GAS_URL_KEY);
                gasUrl = DEFAULT_GAS_URL;
                gasUrlInput.value = '';
                clearCache();
                showToast('è¨­å®šå·²æ¸…é™¤ï¼å³å°‡é‡æ–°æ•´ç†é é¢...');
                setTimeout(() => window.location.reload(), 1500);
            });

            closeSettingsModalBtn.addEventListener('click', () => toggleModal(settingsModal, false));

            // ================================================================
            // åˆ†äº«é€£çµ & QR Code
            // ================================================================
            generateShareBtn.addEventListener('click', async () => {
                const currentGasUrl = gasUrlInput.value.trim() || gasUrl;
                if (!currentGasUrl || !currentGasUrl.startsWith('http')) {
                    showToast('è«‹å…ˆè¼¸å…¥ä¸¦å„²å­˜ GAS ç¶²å€ï¼', true);
                    return;
                }

                // Base64 ç·¨ç¢¼
                const encoded    = btoa(currentGasUrl);
                const baseUrl    = window.location.origin + window.location.pathname;
                const longUrl    = `${baseUrl}?config=${encoded}`;

                shareResult.classList.remove('hidden');
                shareLongUrl.textContent = longUrl;
                shortUrlSection.classList.add('hidden');
                shortUrlLoading.classList.remove('hidden');

                // è¨­å®š QR Codeï¼ˆå…ˆç”¨é•·ç¶²å€ï¼‰
                const qrTarget = encodeURIComponent(longUrl);
                qrCodeImg.src = `https://quickchart.io/qr?text=${qrTarget}&size=180`;

                // å˜—è©¦ç”¢ç”ŸçŸ­ç¶²å€ï¼ˆTinyURLï¼‰
                try {
                    const tinyRes = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`);
                    if (tinyRes.ok) {
                        const shortUrl = await tinyRes.text();
                        if (shortUrl.startsWith('http')) {
                            shareShortUrl.href = shortUrl;
                            shareShortUrl.textContent = shortUrl;
                            shortUrlLoading.classList.add('hidden');
                            shortUrlSection.classList.remove('hidden');
                            // æ›´æ–° QR Code ç‚ºçŸ­ç¶²å€
                            qrCodeImg.src = `https://quickchart.io/qr?text=${encodeURIComponent(shortUrl)}&size=180`;
                        } else {
                            throw new Error('éé æœŸå›æ‡‰');
                        }
                    } else {
                        throw new Error('TinyURL æœå‹™ç„¡å›æ‡‰');
                    }
                } catch (e) {
                    shortUrlLoading.classList.add('hidden');
                    showToast('çŸ­ç¶²å€ç”Ÿæˆå¤±æ•—ï¼ŒQR Code å°‡ä½¿ç”¨åŸå§‹é€£çµã€‚', true);
                }
            });

            copyShortUrlBtn.addEventListener('click', () => {
                const url = shareShortUrl.textContent;
                if (url) {
                    navigator.clipboard.writeText(url)
                        .then(() => showToast('çŸ­ç¶²å€å·²è¤‡è£½ï¼'))
                        .catch(() => showToast('è¤‡è£½å¤±æ•—', true));
                }
            });

            // ================================================================
            // å…¬å‘Šè¼‰å…¥
            // ================================================================
            const fetchAnnouncements = async (forceRefresh = false) => {
                if (!forceRefresh) {
                    const cachedData = loadFromCache();
                    if (cachedData) {
                        systemTitle.textContent = cachedData.title || 'å…¬å‘Šç³»çµ±';
                        document.title = cachedData.title || 'æ™®æ™®é¢¨å…¬å‘Šç³»çµ±';
                        allAnnouncements = (cachedData.announcements || []).map((ann, i) => ({
                            ...ann,
                            originalIndex: i
                        }));
                        currentPage = 1;
                        searchInput.value = '';
                        renderAnnouncements();
                        showToast('å¿«å–è¼‰å…¥å®Œæˆï¼èƒŒæ™¯æª¢æŸ¥æ›´æ–°ä¸­...', false);
                        setTimeout(() => fetchAnnouncementsFromServer(true), 100);
                        return;
                    }
                }

                loader.classList.remove('hidden');
                announcementList.innerHTML = '';
                announcementList.appendChild(loader);

                if (!gasUrl || gasUrl === '') {
                    loader.innerHTML = `<p class="text-xl font-bold text-center">è«‹é»æ“Šå³ä¸Šè§’ âš™ï¸ è¨­å®šæŒ‰éˆ•ï¼Œè¼¸å…¥æ‚¨çš„ GAS ç¶²å€å¾Œé–‹å§‹ä½¿ç”¨ã€‚</p>`;
                    return;
                }

                await fetchAnnouncementsFromServer(false);
            };

            const fetchAnnouncementsFromServer = async (isBackgroundUpdate = false) => {
                try {
                    const response = await fetch(gasUrl);
                    if (!response.ok) throw new Error(`ç¶²è·¯å›æ‡‰éŒ¯èª¤: ${response.statusText}`);
                    const data = await response.json();

                    const cachedData = loadFromCache();
                    const hasChanged = !cachedData ||
                        JSON.stringify(data.announcements) !== JSON.stringify(cachedData.announcements) ||
                        data.title !== cachedData.title;

                    if (hasChanged || !isBackgroundUpdate) {
                        systemTitle.textContent = data.title || 'å…¬å‘Šç³»çµ±';
                        document.title = data.title || 'æ™®æ™®é¢¨å…¬å‘Šç³»çµ±';
                        // rowIndex ç”± GAS æä¾›ï¼ˆ0-based è³‡æ–™åˆ—ä½ç½®ï¼‰ï¼Œç”¨æ–¼ç·¨è¼¯/åˆªé™¤ï¼›
                        // originalIndex ç‚ºå‰ç«¯é™£åˆ—åºè™Ÿï¼Œç”¨æ–¼æŸ¥æ‰¾å…¬å‘Š
                        allAnnouncements = (data.announcements || []).map((ann, i) => ({
                            ...ann,
                            originalIndex: i
                        }));
                        currentPage = 1;
                        if (!isBackgroundUpdate) searchInput.value = '';
                        renderAnnouncements();
                        saveToCache(data);
                        if (isBackgroundUpdate && hasChanged) showToast('è³‡æ–™å·²æ›´æ–°ï¼');
                    } else if (isBackgroundUpdate) {
                        console.log('èƒŒæ™¯æª¢æŸ¥ï¼šè³‡æ–™ç„¡è®Šæ›´');
                    }

                    if (!isBackgroundUpdate) loader.classList.add('hidden');
                } catch (error) {
                    console.error('å–å¾—å…¬å‘Šå¤±æ•—:', error);
                    if (!isBackgroundUpdate) {
                        loader.classList.add('hidden');
                        announcementList.innerHTML = `<p class="text-xl font-bold text-red-600 text-center">ç„¡æ³•è¼‰å…¥å…¬å‘Šã€‚<br>è«‹é»æ“Š âš™ï¸ ç¢ºèªæ‚¨çš„ GAS ç¶²å€æ˜¯å¦æ­£ç¢ºï¼Œæˆ–ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸ã€‚</p>`;
                    } else {
                        showToast('èƒŒæ™¯æ›´æ–°å¤±æ•—ï¼Œå°‡ä½¿ç”¨å¿«å–è³‡æ–™', true);
                    }
                }
            };

            // ================================================================
            // æ¸²æŸ“å…¬å‘Šï¼ˆè¡¨æ ¼å¼ï¼Œæ¯é  10 ç­†ï¼‰
            // ================================================================
            const renderAnnouncements = () => {
                const searchTerm = searchInput.value.toLowerCase();
                // allAnnouncements å·²ä¾æ™‚é–“ç”±æ–°åˆ°èˆŠæ’åºï¼ˆGAS ç«¯æ’åºï¼‰
                const filtered = allAnnouncements.filter(ann =>
                    String(ann.title || '').toLowerCase().includes(searchTerm)
                );

                announcementList.innerHTML = '';
                paginationContainer.innerHTML = '';

                if (filtered.length === 0) {
                    announcementList.innerHTML = `<p class="text-xl font-bold text-center py-16">${searchTerm ? 'æ‰¾ä¸åˆ°ç›¸ç¬¦çš„å…¬å‘Šï¼' : 'ç›®å‰æ²’æœ‰ä»»ä½•å…¬å‘Šï¼'}</p>`;
                    return;
                }

                const totalPages     = Math.ceil(filtered.length / itemsPerPage);
                const startIndex     = (currentPage - 1) * itemsPerPage;
                const paginatedItems = filtered.slice(startIndex, startIndex + itemsPerPage);

                // å»ºç«‹è¡¨æ ¼
                const tableWrap = document.createElement('div');
                tableWrap.className = 'overflow-x-auto';

                const table = document.createElement('table');
                table.className = 'ann-table';

                // æ¨™é¡Œåˆ—
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th class="col-no">#</th>
                        <th class="col-title">æ¨™é¡Œ</th>
                        <th class="col-preview">å…§å®¹æ‘˜è¦</th>
                        <th class="col-links">ç›¸é—œé€£çµ</th>
                    </tr>`;
                table.appendChild(thead);

                // è³‡æ–™åˆ—
                const tbody = document.createElement('tbody');
                paginatedItems.forEach((item, idx) => {
                    // å…¨åŸŸåºè™Ÿï¼šæœ€æ–°çš„ç‚º 1
                    const globalNo = startIndex + idx + 1;

                    // å…§æ–‡å‰ 10 å­—
                    const preview = (item.content || '').replace(/\n/g, ' ');
                    const previewText = preview.length > 20
                        ? preview.slice(0, 20) + '...'
                        : (preview || 'â€”');

                    // é€£çµ chipsï¼ˆé»æ“Šä¸è§¸ç™¼ showDetailï¼‰
                    const links = Array.isArray(item.linkUrls)
                        ? item.linkUrls.filter(u => u)
                        : [];
                    const linksHtml = links.length > 0
                        ? links.map((url, li) =>
                            `<a class="link-chip" href="${escHtml(url)}" target="_blank" rel="noopener noreferrer"
                               data-stopclick="1">é€£çµ${li + 1}</a>`
                          ).join('')
                        : '<span class="text-gray-400 text-xs">â€”</span>';

                    const timeStr = item.timestamp
                        ? new Date(item.timestamp).toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
                        : '';

                    const tr = document.createElement('tr');
                    tr.dataset.originalIndex = item.originalIndex;
                    tr.innerHTML = `
                        <td class="col-no text-gray-500">${globalNo}</td>
                        <td class="col-title">
                            <div>${escHtml(item.title || '')}</div>
                            ${timeStr ? `<div class="text-xs text-gray-400 font-normal mt-0.5">${escHtml(timeStr)}</div>` : ''}
                        </td>
                        <td class="col-preview text-sm">${escHtml(previewText)}</td>
                        <td class="col-links">${linksHtml}</td>`;

                    // é»æ“Šæ•´åˆ—é–‹å•Ÿè©³æƒ…ï¼Œä½†è‹¥é»åˆ° link-chip å‰‡ä¸è§¸ç™¼
                    tr.addEventListener('click', (e) => {
                        if (e.target.closest('[data-stopclick]')) return;
                        showDetail(parseInt(tr.dataset.originalIndex, 10));
                    });

                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                tableWrap.appendChild(table);
                announcementList.appendChild(tableWrap);

                renderPagination(totalPages, filtered.length);
            };

            // HTML è·³è„«ï¼ˆé¿å… XSSï¼‰
            const escHtml = (str) => String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');

            const renderPagination = (totalPages, totalItems) => {
                if (totalPages <= 1) return;

                const prevBtn = document.createElement('button');
                prevBtn.textContent = 'â—€ ä¸Šä¸€é ';
                prevBtn.className = 'pagination-btn font-bold bg-yellow-400 px-4 py-2 rounded-lg pop-shadow-sm pop-button text-sm';
                prevBtn.disabled = currentPage === 1;
                prevBtn.addEventListener('click', () => {
                    if (currentPage > 1) { currentPage--; renderAnnouncements(); announcementList.scrollIntoView({ behavior: 'smooth' }); }
                });
                paginationContainer.appendChild(prevBtn);

                // é ç¢¼æŒ‰éˆ•ï¼ˆæœ€å¤šé¡¯ç¤º 5 å€‹ï¼‰
                const maxPageBtns = 5;
                let pageStart = Math.max(1, currentPage - Math.floor(maxPageBtns / 2));
                let pageEnd   = Math.min(totalPages, pageStart + maxPageBtns - 1);
                if (pageEnd - pageStart < maxPageBtns - 1) pageStart = Math.max(1, pageEnd - maxPageBtns + 1);

                for (let p = pageStart; p <= pageEnd; p++) {
                    const pgBtn = document.createElement('button');
                    pgBtn.textContent = p;
                    pgBtn.className = `pagination-btn font-bold px-3 py-2 rounded-lg pop-shadow-sm pop-button text-sm ${p === currentPage ? 'bg-blue-600 text-white' : 'bg-yellow-400'}`;
                    pgBtn.disabled = p === currentPage;
                    const pg = p;
                    pgBtn.addEventListener('click', () => {
                        currentPage = pg;
                        renderAnnouncements();
                        announcementList.scrollIntoView({ behavior: 'smooth' });
                    });
                    paginationContainer.appendChild(pgBtn);
                }

                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'ä¸‹ä¸€é  â–¶';
                nextBtn.className = 'pagination-btn font-bold bg-yellow-400 px-4 py-2 rounded-lg pop-shadow-sm pop-button text-sm';
                nextBtn.disabled = currentPage === totalPages;
                nextBtn.addEventListener('click', () => {
                    if (currentPage < totalPages) { currentPage++; renderAnnouncements(); announcementList.scrollIntoView({ behavior: 'smooth' }); }
                });
                paginationContainer.appendChild(nextBtn);

                const info = document.createElement('span');
                info.textContent = `å…± ${totalItems} ç­†`;
                info.className = 'font-bold text-white text-sm ml-2';
                paginationContainer.appendChild(info);
            };

            // ================================================================
            // å…¬å‘Šè©³æƒ…
            // ================================================================
            const showDetail = (originalIndex) => {
                const item = allAnnouncements.find(ann => ann.originalIndex === originalIndex);
                if (!item) return;

                currentDetailIdx = originalIndex;   // è¨˜éŒ„ä¾›ç·¨è¼¯/åˆªé™¤ä½¿ç”¨
                detailTitle.style.fontSize = '';
                detailTitle.textContent = item.title;
                detailTimestamp.textContent = `ç™¼å¸ƒæ–¼ ${new Date(item.timestamp).toLocaleString()}`;
                detailContent.textContent = item.content;

                if (item.imageBase64 && item.imageBase64.startsWith('data:image')) {
                    detailImage.src = item.imageBase64;
                    detailImage.classList.remove('hidden');
                } else {
                    detailImage.classList.add('hidden');
                }

                detailLinksContainer.innerHTML = '';
                if (item.linkUrls && Array.isArray(item.linkUrls) && item.linkUrls.length > 0) {
                    const linksTitle = document.createElement('p');
                    linksTitle.className = 'font-bold mt-4';
                    linksTitle.textContent = 'ç›¸é—œé€£çµ:';
                    detailLinksContainer.appendChild(linksTitle);
                    let linkNo = 1;
                    item.linkUrls.forEach(url => {
                        if (url) {
                            const a = document.createElement('a');
                            a.href = url;
                            a.textContent = `é€£çµ${linkNo++}ï¼š${url}`;
                            a.target = '_blank';
                            a.className = 'block text-blue-600 hover:underline break-all';
                            detailLinksContainer.appendChild(a);
                        }
                    });
                    detailLinksContainer.classList.remove('hidden');
                } else {
                    detailLinksContainer.classList.add('hidden');
                }

                toggleModal(detailModal, true);

                const container = detailTitle.parentElement;
                const containerWidth = container.clientWidth;
                let fs = parseFloat(window.getComputedStyle(detailTitle).fontSize);
                while (detailTitle.scrollWidth > containerWidth && fs > 12) {
                    fs -= 1;
                    detailTitle.style.fontSize = fs + 'px';
                }
            };

            // ================================================================
            // åœ–ç‰‡ä¸Šå‚³
            // ================================================================
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                fileNameSpan.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const maxWidth = 600;
                        const scale = maxWidth / img.width;
                        const canvas = document.createElement('canvas');
                        canvas.width  = Math.min(img.width, maxWidth);
                        canvas.height = img.height * (img.width > maxWidth ? scale : 1);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        imageBase64 = canvas.toDataURL('image/jpeg', 0.8);
                        imagePreview.src = imageBase64;
                        imagePreview.classList.remove('hidden');
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };

            // ================================================================
            // ç™¼å¸ƒå…¬å‘Š
            // ================================================================
            const handlePublish = async (e) => {
                e.preventDefault();
                submitBtn.classList.add('hidden');
                publishLoader.classList.remove('hidden');

                const linkInputs = linksContainer.querySelectorAll('input');
                const links = Array.from(linkInputs).map(i => i.value).filter(v => v.trim() !== '');

                const data = {
                    title: titleInput.value,
                    content: contentInput.value,
                    imageBase64: imageBase64,
                    linkUrls: links,
                    password: currentPassword,
                };

                try {
                    await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                    });
                    showToast('å…¬å‘Šç™¼å¸ƒè«‹æ±‚å·²é€å‡ºï¼');
                    toggleModal(publishModal, false);
                    resetPublishForm();
                    clearCache();
                } catch (error) {
                    console.error('ç™¼å¸ƒå¤±æ•—:', error);
                    showToast('ç™¼å¸ƒå¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°éŒ¯èª¤è¨Šæ¯ã€‚', true);
                } finally {
                    submitBtn.classList.remove('hidden');
                    publishLoader.classList.add('hidden');
                    showToast('è³‡æ–™æ›´æ–°ä¸­ï¼Œè«‹ç¨å€™...');
                    setTimeout(() => fetchAnnouncements(true), 3000);
                }
            };

            const makeLinkInput = (container, defaultVal = '') => {
                const group = document.createElement('div');
                group.className = 'flex items-center space-x-2';
                const input = document.createElement('input');
                input.type = 'url';
                input.className = 'w-full p-3 rounded-md border-2 border-black text-lg';
                input.placeholder = 'https://...';
                input.value = defaultVal;
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.textContent = 'ç§»é™¤';
                removeBtn.className = 'bg-red-500 text-white px-3 py-1 rounded-md text-sm font-bold pop-button';
                removeBtn.onclick = () => group.remove();
                group.appendChild(input);
                group.appendChild(removeBtn);
                container.appendChild(group);
            };

            const addLinkInput = () => makeLinkInput(linksContainer);

            const resetPublishForm = () => {
                publishForm.reset();
                imagePreview.classList.add('hidden');
                fileNameSpan.textContent = 'æœªé¸æ“‡ä»»ä½•æª”æ¡ˆ';
                linksContainer.innerHTML = '';
                addLinkInput();
                imageBase64 = null;
                currentPassword = null;
            };

            // ================================================================
            // é–‹å•Ÿç·¨è¼¯è¦–çª—ï¼ˆå¸¶å…¥ç›®å‰å…¬å‘Šè³‡æ–™ï¼‰
            // ================================================================
            const openEditModal = () => {
                const item = allAnnouncements.find(a => a.originalIndex === currentDetailIdx);
                if (!item) return;
                editTitleInput.value   = item.title || '';
                editContentInput.value = item.content || '';
                editImageBase64 = item.imageBase64 || null;
                editFileName.textContent = 'æœªé¸æ“‡ï¼ˆä¿ç•™åŸåœ–ï¼‰';
                if (editImageBase64 && editImageBase64.startsWith('data:image')) {
                    editImagePreview.src = editImageBase64;
                    editImagePreview.classList.remove('hidden');
                } else {
                    editImagePreview.classList.add('hidden');
                }
                editLinksContainer.innerHTML = '';
                const links = item.linkUrls && Array.isArray(item.linkUrls) ? item.linkUrls : [];
                if (links.length === 0) {
                    makeLinkInput(editLinksContainer);
                } else {
                    links.forEach(url => makeLinkInput(editLinksContainer, url));
                }
                toggleModal(editModal, true);
            };

            editAddLinkBtn.addEventListener('click', () => makeLinkInput(editLinksContainer));

            // ç·¨è¼¯åœ–ç‰‡é¸å–
            editImageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                editFileName.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.onload = () => {
                        const maxW = 600;
                        const scale = maxW / img.width;
                        const canvas = document.createElement('canvas');
                        canvas.width  = Math.min(img.width, maxW);
                        canvas.height = img.height * (img.width > maxW ? scale : 1);
                        canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                        editImageBase64 = canvas.toDataURL('image/jpeg', 0.8);
                        editImagePreview.src = editImageBase64;
                        editImagePreview.classList.remove('hidden');
                    };
                    img.src = ev.target.result;
                };
                reader.readAsDataURL(file);
            });

            // ================================================================
            // æäº¤ç·¨è¼¯
            // ================================================================
            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                editSubmitBtn.classList.add('hidden');
                editLoader.classList.remove('hidden');

                const links = Array.from(editLinksContainer.querySelectorAll('input'))
                    .map(i => i.value).filter(v => v.trim() !== '');

                const item = allAnnouncements.find(a => a.originalIndex === currentDetailIdx);
                const payload = {
                    action:      'edit',
                    rowIndex:    item.rowIndex,   // GAS å›å‚³çš„ 0-based è³‡æ–™åˆ—ä½ç½®ï¼ŒGAS å…§æœƒåŠ  2
                    title:       editTitleInput.value,
                    content:     editContentInput.value,
                    imageBase64: editImageBase64 || '',
                    linkUrls:    links,
                    password:    currentPassword,
                };

                try {
                    await fetch(gasUrl, {
                        method: 'POST',
                        mode:   'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body:   JSON.stringify(payload),
                    });
                    showToast('ç·¨è¼¯è«‹æ±‚å·²é€å‡ºï¼Œæ›´æ–°ä¸­...');
                    toggleModal(editModal, false);
                    clearCache();
                } catch (err) {
                    showToast('é€å‡ºå¤±æ•—ï¼š' + err.message, true);
                } finally {
                    editSubmitBtn.classList.remove('hidden');
                    editLoader.classList.add('hidden');
                    setTimeout(() => fetchAnnouncements(true), 3000);
                }
            });

            // ================================================================
            // åˆªé™¤å…¬å‘Š
            // ================================================================
            const confirmAndDelete = async () => {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡å…¬å‘Šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
                const item = allAnnouncements.find(a => a.originalIndex === currentDetailIdx);
                if (!item) return;
                const payload = {
                    action:   'delete',
                    rowIndex: item.rowIndex,   // GAS å›å‚³çš„ 0-based è³‡æ–™åˆ—ä½ç½®
                    password: currentPassword,
                };
                try {
                    await fetch(gasUrl, {
                        method: 'POST',
                        mode:   'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body:   JSON.stringify(payload),
                    });
                    showToast('åˆªé™¤è«‹æ±‚å·²é€å‡ºï¼Œæ›´æ–°ä¸­...');
                    toggleModal(detailModal, false);
                    clearCache();
                } catch (err) {
                    showToast('åˆªé™¤å¤±æ•—ï¼š' + err.message, true);
                } finally {
                    setTimeout(() => fetchAnnouncements(true), 3000);
                }
            };

            // ================================================================
            // GAS ç¨‹å¼ç¢¼ï¼ˆä¾›èªªæ˜é é¡¯ç¤ºï¼‰
            // ================================================================
            const gasCode = `// =====================================================
// æ™®æ™®é¢¨å…¬å‘Šç³»çµ± GAS å¾Œç«¯  (æ”¯æ´ æ–°å¢ / ç·¨è¼¯ / åˆªé™¤ / å¯†ç¢¼é©—è­‰)
// =====================================================
const ANNOUNCEMENT_SHEET_NAME = "å…¬å‘Šè³‡æ–™";
const SETTINGS_SHEET_NAME     = "ç³»çµ±è¨­å®š";
const ANNOUNCEMENT_HEADER     = ["æ™‚é–“æˆ³", "æ¨™é¡Œ", "å…§å®¹", "åœ–ç‰‡è³‡æ–™ (Base64)", "ç›¸é—œé€£çµ (JSON)"];
const SETTINGS_HEADER         = ["è¨­å®šé …ç›®", "è¨­å®šå€¼"];
const SETTINGS_DEFAULTS       = [["ç³»çµ±æ¨™é¡Œ", "å…¬å‘Šç³»çµ±"], ["ç™¼å¸ƒå¯†ç¢¼", ""]];

// â”€â”€ å»ºç«‹æˆ–å–å¾—å·¥ä½œè¡¨ï¼ˆåªåœ¨é¦–æ¬¡ä¸å­˜åœ¨æ™‚å»ºç«‹æ¨™é¡Œè¡Œï¼‰â”€â”€
function getOrCreateSheet(sheetName, header) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(sheetName);
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    sheet.appendRow(header);
    sheet.getRange(1, 1, 1, header.length)
         .setFontWeight("bold").setBackground("#d9ead3");
  }
  return sheet;
}

// â”€â”€ è®€å–è¨­å®šï¼ˆä¿®æ­£ï¼šé¿å…é‡è¤‡æ–°å¢é è¨­åˆ—ï¼‰â”€â”€
function getSettings() {
  const sheet = getOrCreateSheet(SETTINGS_SHEET_NAME, SETTINGS_HEADER);
  const data  = sheet.getDataRange().getValues();
  let settings = { systemTitle: "å…¬å‘Šç³»çµ±", publishPassword: "" };

  // å·²æœ‰è³‡æ–™åˆ—ï¼ˆç¬¬ 2 åˆ—èµ·ï¼‰â†’ åªè®€å–ï¼Œä¸æ–°å¢
  if (data.length > 1) {
    for (let i = 1; i < data.length; i++) {
      const key   = String(data[i][0]).trim();
      const value = data[i][1];
      if (key === "ç³»çµ±æ¨™é¡Œ" && value !== "") settings.systemTitle    = String(value);
      if (key === "ç™¼å¸ƒå¯†ç¢¼")                 settings.publishPassword = String(value);
    }
  } else {
    // å·¥ä½œè¡¨å‰›å»ºç«‹ï¼ˆåªæœ‰æ¨™é¡Œè¡Œï¼‰ï¼Œè£œä¸Šé è¨­è¨­å®šåˆ—
    SETTINGS_DEFAULTS.forEach(row => sheet.appendRow(row));
  }
  return settings;
}

// â”€â”€ å¯†ç¢¼é©—è­‰ â”€â”€
function checkPassword(settings, inputPwd) {
  const stored = String(settings.publishPassword || "").trim();
  if (stored === "") return true;                      // æœªè¨­å¯†ç¢¼ï¼Œä»»ä½•äººå¯æ“ä½œ
  return String(inputPwd || "").trim() === stored;
}

// â”€â”€ GETï¼šå–å¾—å…¬å‘Šåˆ—è¡¨ æˆ– é©—è­‰å¯†ç¢¼ â”€â”€
function doGet(e) {
  try {
    const params = e.parameter || {};

    // ?action=verify&password=XXX
    if (params.action === "verify") {
      const settings = getSettings();
      const valid = checkPassword(settings, params.password || "");
      return json({ valid: valid });
    }

    // é è¨­ï¼šå›å‚³æ‰€æœ‰å…¬å‘Š
    const settings = getSettings();
    const sheet = getOrCreateSheet(ANNOUNCEMENT_SHEET_NAME, ANNOUNCEMENT_HEADER);
    const rows  = sheet.getDataRange().getValues();
    rows.shift(); // ç§»é™¤æ¨™é¡Œè¡Œ

    const announcements = rows.map((row, idx) => {
      let linkUrls = [];
      try { if (row[4]) linkUrls = JSON.parse(row[4]); } catch (_) {}
      return {
        rowIndex:    idx,            // 0-basedï¼Œå‰ç«¯éœ€ä¿å­˜æ­¤å€¼ä¾›ç·¨è¼¯/åˆªé™¤ä½¿ç”¨
        timestamp:   row[0],
        title:       row[1],
        content:     row[2],
        imageBase64: row[3],
        linkUrls:    linkUrls
      };
    }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    return json({ title: settings.systemTitle, announcements: announcements });

  } catch (err) {
    return json({ error: err.message });
  }
}

// â”€â”€ POSTï¼šæ–°å¢ / ç·¨è¼¯ / åˆªé™¤ â”€â”€
function doPost(e) {
  try {
    const settings = getSettings();
    const payload  = JSON.parse(e.postData.contents);
    const action   = payload.action || "publish";

    if (!checkPassword(settings, payload.password)) {
      return json({ status: "error", message: "å¯†ç¢¼éŒ¯èª¤" });
    }

    const sheet = getOrCreateSheet(ANNOUNCEMENT_SHEET_NAME, ANNOUNCEMENT_HEADER);

    if (action === "publish") {
      if (!payload.title || !payload.content) throw new Error("æ¨™é¡Œèˆ‡å…§å®¹ç‚ºå¿…å¡«");
      sheet.appendRow([
        new Date(),
        payload.title,
        payload.content,
        payload.imageBase64 || "",
        JSON.stringify(payload.linkUrls || [])
      ]);
      return json({ status: "success" });
    }

    if (action === "edit") {
      // rowIndex ç‚º 0-based è³‡æ–™åˆ—ç´¢å¼•ï¼›è©¦ç®—è¡¨ç¬¬ 1 åˆ—æ˜¯æ¨™é¡Œ â†’ +2
      const sheetRow = Number(payload.rowIndex) + 2;
      if (isNaN(sheetRow) || sheetRow < 2) throw new Error("ç„¡æ•ˆçš„åˆ—ç´¢å¼•");
      sheet.getRange(sheetRow, 1).setValue(sheet.getRange(sheetRow, 1).getValue()); // ä¿ç•™æ™‚é–“æˆ³
      sheet.getRange(sheetRow, 2).setValue(payload.title);
      sheet.getRange(sheetRow, 3).setValue(payload.content);
      if (payload.imageBase64 !== undefined) {
        sheet.getRange(sheetRow, 4).setValue(payload.imageBase64);
      }
      sheet.getRange(sheetRow, 5).setValue(JSON.stringify(payload.linkUrls || []));
      return json({ status: "success" });
    }

    if (action === "delete") {
      const sheetRow = Number(payload.rowIndex) + 2;
      if (isNaN(sheetRow) || sheetRow < 2) throw new Error("ç„¡æ•ˆçš„åˆ—ç´¢å¼•");
      sheet.deleteRow(sheetRow);
      return json({ status: "success" });
    }

    throw new Error("æœªçŸ¥çš„ action: " + action);

  } catch (err) {
    return json({ status: "error", message: err.message });
  }
}

// â”€â”€ è¼”åŠ©ï¼šè¼¸å‡º JSON â”€â”€
function json(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}`;

            // ================================================================
            // èªªæ˜å…§å®¹
            // ================================================================
            const populateHelpContent = () => {
                const helpContentEl = document.getElementById('help-content');
                helpContentEl.innerHTML = `
                    <h2 class="font-black text-4xl text-center text-[#003366]">è¨­å®šèªªæ˜</h2>
                    <p class="text-lg font-bold mt-4">è«‹ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿè¨­å®šæ‚¨çš„ Google è©¦ç®—è¡¨å¾Œç«¯ï¼š</p>

                    <h3 class="text-2xl font-bold mt-6">æ­¥é©Ÿä¸€ï¼šå»ºç«‹ Google è©¦ç®—è¡¨</h3>
                    <p>å‰å¾€ <a href="https://sheets.google.com" target="_blank" class="text-blue-600 underline">Google Sheets</a> æ–°å¢ä¸€ä»½ç©ºç™½è©¦ç®—è¡¨ã€‚</p>

                    <h3 class="text-2xl font-bold mt-6">æ­¥é©ŸäºŒï¼šé–‹å•Ÿ Apps Script</h3>
                    <p>åœ¨è©¦ç®—è¡¨ä¸­ï¼Œé»é¸ä¸Šæ–¹é¸å–®ã€Œæ“´å……åŠŸèƒ½ã€â†’ã€ŒApps Scriptã€ã€‚</p>

                    <h3 class="text-2xl font-bold mt-6">æ­¥é©Ÿä¸‰ï¼šè²¼ä¸Šç¨‹å¼ç¢¼</h3>
                    <p>å°‡ç·¨è¼¯å™¨å…§çš„é è¨­å…§å®¹æ¸…ç©ºï¼Œè²¼å…¥ä»¥ä¸‹æœ€æ–°çš„ç¨‹å¼ç¢¼ï¼š</p>
                    <div class="relative mt-2">
                        <button id="copy-gas-code-btn" class="absolute top-2 right-2 bg-blue-500 text-white px-3 py-1 rounded pop-shadow-sm pop-button text-sm font-bold z-10">ğŸ“‹ è¤‡è£½ç¨‹å¼ç¢¼</button>
                        <pre class="bg-gray-800 text-green-300 p-4 pt-10 rounded-lg overflow-x-auto text-sm"><code id="gas-code-block"></code></pre>
                    </div>

                    <h3 class="text-2xl font-bold mt-6">æ­¥é©Ÿå››ï¼šéƒ¨ç½²ç¶²é æ‡‰ç”¨</h3>
                    <ol class="list-decimal list-inside space-y-2">
                        <li>é»é¸å³ä¸Šè§’ã€Œéƒ¨ç½²ã€â†’ã€Œæ–°å¢éƒ¨ç½²ä½œæ¥­ã€ã€‚</li>
                        <li>é¡å‹é¸æ“‡ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€ã€‚</li>
                        <li><strong>ã€Œèª°å¯ä»¥å­˜å–ã€å‹™å¿…è¨­å®šç‚ºã€Œä»»ä½•äººã€</strong>ï¼Œå¦å‰‡ç„¡æ³•å…¬é–‹è®€å–å…¬å‘Šã€‚</li>
                        <li>é»é¸ã€Œéƒ¨ç½²ã€ï¼Œè¤‡è£½ç”Ÿæˆçš„ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ URLã€ã€‚</li>
                        <li>âš ï¸ è‹¥å·²æœ‰èˆŠç‰ˆéƒ¨ç½²ï¼Œè«‹å‹™å¿…é¸ã€Œ<strong>ç®¡ç†éƒ¨ç½²ä½œæ¥­</strong>ã€â†’ ç·¨è¼¯ â†’ ç‰ˆæœ¬é¸ã€Œæ–°ç‰ˆæœ¬ã€å†å„²å­˜ï¼Œå¦å‰‡ä¿®æ”¹ä¸æœƒç”Ÿæ•ˆã€‚</li>
                    </ol>

                    <h3 class="text-2xl font-bold mt-6">æ­¥é©Ÿäº”ï¼šè¨­å®šç³»çµ±æ¨™é¡Œèˆ‡å¯†ç¢¼</h3>
                    <ol class="list-decimal list-inside space-y-2">
                        <li>éƒ¨ç½²å®Œæˆå¾Œï¼Œé»æ“Š URL é–‹å•Ÿä¸€æ¬¡ï¼Œç³»çµ±æœƒè‡ªå‹•åœ¨è©¦ç®—è¡¨å»ºç«‹ã€Œå…¬å‘Šè³‡æ–™ã€å’Œã€Œç³»çµ±è¨­å®šã€å…©å€‹å·¥ä½œè¡¨ã€‚</li>
                        <li>é»é–‹ã€Œç³»çµ±è¨­å®šã€å·¥ä½œè¡¨ã€‚</li>
                        <li>åœ¨ <strong>B2</strong> å„²å­˜æ ¼ä¿®æ”¹å…¬å‘Šç³»çµ±æ¨™é¡Œã€‚</li>
                        <li>åœ¨ <strong>B3</strong> å„²å­˜æ ¼è¼¸å…¥ç™¼å¸ƒ / ç®¡ç†å¯†ç¢¼ï¼ˆ<strong>ç•™ç™½è¡¨ç¤ºä»»ä½•äººçš†å¯æ“ä½œï¼Œå»ºè­°è¨­å®š</strong>ï¼‰ã€‚</li>
                    </ol>

                    <h3 class="text-2xl font-bold mt-6">æ­¥é©Ÿå…­ï¼šé€£ç·šè¨­å®š</h3>
                    <ol class="list-decimal list-inside space-y-2">
                        <li>é»æ“Šæœ¬é å³ä¸Šè§’ âš™ï¸ è¨­å®šæŒ‰éˆ•ã€‚</li>
                        <li>å°‡å‰›æ‰è¤‡è£½çš„ GAS ç¶²é æ‡‰ç”¨ URL è²¼å…¥è¼¸å…¥æ¡†ã€‚</li>
                        <li>é»æ“Šã€ŒğŸ’¾ å„²å­˜è¨­å®šã€ï¼Œç³»çµ±å³æœƒé–‹å§‹é€£ç·šã€‚</li>
                    </ol>

                    <h3 class="text-2xl font-bold mt-6">âœï¸ ç·¨è¼¯ / ğŸ—‘ï¸ åˆªé™¤å…¬å‘Š</h3>
                    <p>é»æ“Šä»»æ„å…¬å‘Šé€²å…¥è©³æƒ…é ï¼Œåº•éƒ¨æœƒå‡ºç¾ã€Œç·¨è¼¯ã€èˆ‡ã€Œåˆªé™¤ã€æŒ‰éˆ•ã€‚é»æ“Šå¾Œéœ€è¼¸å…¥ç®¡ç†å¯†ç¢¼æ‰èƒ½é€²è¡Œæ“ä½œã€‚è‹¥è©¦ç®—è¡¨æœªè¨­å¯†ç¢¼ï¼Œç•™ç©ºé€å‡ºå³å¯ã€‚</p>

                    <h3 class="text-2xl font-bold mt-6">é€²éšï¼šåˆ†äº«çµ¦å…¶ä»–äººä½¿ç”¨</h3>
                    <p>åœ¨è¨­å®šè¦–çª—ä¸­ï¼Œä½¿ç”¨ã€ŒğŸ“¤ ç”¢ç”Ÿåˆ†äº«é€£çµã€åŠŸèƒ½ï¼Œå¯ç”Ÿæˆé™„æœ‰ Base64 åŠ å¯† GAS ç¶²å€çš„åˆ†äº«é€£çµæˆ– QR Codeï¼Œæ–¹ä¾¿å…¶ä»–è£ç½®æƒæå³å¯ç›´æ¥ä½¿ç”¨æœ¬ç³»çµ±ã€‚</p>
                `;
                document.getElementById('gas-code-block').textContent = gasCode;
            };

            // ================================================================
            // äº‹ä»¶ç›£è½å™¨
            // ================================================================
            publishBtn.addEventListener('click', () => {
                passwordPurpose = 'publish';
                passwordModalTitle.textContent = 'ç™¼å¸ƒæ–°å…¬å‘Š';
                passwordModalHint.textContent = 'è‹¥æœªè¨­å®šå¯†ç¢¼è«‹ç•™ç©ºç›´æ¥é€å‡º';
                passwordError.classList.add('hidden');
                passwordInput.value = '';
                resetPublishForm();
                toggleModal(passwordModal, true);
            });

            editAnnBtn.addEventListener('click', () => {
                passwordPurpose = 'edit';
                passwordModalTitle.textContent = 'ç·¨è¼¯å…¬å‘Š';
                passwordModalHint.textContent = 'è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼ˆç•™ç©º=ç„¡å¯†ç¢¼ï¼‰';
                passwordError.classList.add('hidden');
                passwordInput.value = '';
                toggleModal(detailModal, false);
                toggleModal(passwordModal, true);
            });

            deleteAnnBtn.addEventListener('click', () => {
                passwordPurpose = 'delete';
                passwordModalTitle.textContent = 'åˆªé™¤å…¬å‘Š';
                passwordModalHint.textContent = 'è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼ˆç•™ç©º=ç„¡å¯†ç¢¼ï¼‰';
                passwordError.classList.add('hidden');
                passwordInput.value = '';
                toggleModal(detailModal, false);
                toggleModal(passwordModal, true);
            });

            helpBtn.addEventListener('click', () => toggleModal(helpModal, true));
            addLinkBtn.addEventListener('click', addLinkInput);

            searchInput.addEventListener('input', () => {
                currentPage = 1;
                renderAnnouncements();
            });

            closePasswordModalBtn.addEventListener('click', () => toggleModal(passwordModal, false));
            closePublishModalBtn.addEventListener('click', () => toggleModal(publishModal, false));
            closeHelpModalBtn.addEventListener('click', () => toggleModal(helpModal, false));
            closeDetailModalBtn.addEventListener('click', () => toggleModal(detailModal, false));
            closeEditModalBtn.addEventListener('click', () => toggleModal(editModal, false));

            // ================================================================
            // å¯†ç¢¼è¦–çª—ï¼šé€å‡ºæ™‚å‘ GAS é©—è­‰å¯†ç¢¼ï¼Œå†ä¾ purpose åŸ·è¡Œå¾ŒçºŒå‹•ä½œ
            // ================================================================
            passwordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const enteredPwd = passwordInput.value;
                passwordError.classList.add('hidden');
                passwordSubmitBtn.disabled = true;
                passwordSubmitBtn.textContent = 'é©—è­‰ä¸­...';

                // å‘ GAS é©—è­‰å¯†ç¢¼
                const isValid = await verifyPassword(enteredPwd);
                passwordSubmitBtn.disabled = false;
                passwordSubmitBtn.textContent = 'ç¢ºèª';

                if (!isValid) {
                    passwordError.classList.remove('hidden');
                    passwordInput.value = '';
                    return;
                }

                currentPassword = enteredPwd;
                passwordInput.value = '';
                passwordError.classList.add('hidden');
                toggleModal(passwordModal, false);

                if (passwordPurpose === 'publish') {
                    toggleModal(publishModal, true);
                } else if (passwordPurpose === 'edit') {
                    openEditModal();
                } else if (passwordPurpose === 'delete') {
                    confirmAndDelete();
                }
            });

            // ================================================================
            // å‘ GAS é©—è­‰å¯†ç¢¼ï¼ˆGET action=verifyï¼‰
            // ================================================================
            const verifyPassword = async (pwd) => {
                if (!gasUrl) return false;
                try {
                    const url = `${gasUrl}?action=verify&password=${encodeURIComponent(pwd)}`;
                    const res = await fetch(url);
                    const json = await res.json();
                    return json.valid === true;
                } catch (e) {
                    showToast('é©—è­‰å¤±æ•—ï¼Œè«‹ç¢ºèª GAS ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚', true);
                    return false;
                }
            };

            publishForm.addEventListener('submit', handlePublish);
            imageUploadInput.addEventListener('change', handleImageUpload);

            copyContentBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(detailContent.textContent)
                    .then(() => showToast('å…§å®¹å·²è¤‡è£½ï¼'))
                    .catch(() => showToast('è¤‡è£½å¤±æ•—', true));
            });

            helpModal.addEventListener('click', (e) => {
                if (e.target && e.target.id === 'copy-gas-code-btn') {
                    navigator.clipboard.writeText(gasCode)
                        .then(() => showToast('GAS ç¨‹å¼ç¢¼å·²è¤‡è£½ï¼'))
                        .catch(() => showToast('è¤‡è£½å¤±æ•—', true));
                }
            });

            // --- åˆå§‹åŒ– ---
            populateHelpContent();
            fetchAnnouncements();
        });
    </script>

</body>
</html>
